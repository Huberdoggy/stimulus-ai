<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stimulus AI — Adapter Card</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

  <!-- Simple intro layer: centered PNG on black, soft pulse, 5s -->
  <div id="intro" class="intro">
    <img src="/static/mcburney.png" alt="McBurney Group mark" id="introImg" class="intro__img">
  </div>

  <!-- App content (revealed after intro) -->
  <div id="app" class="app">
    <header class="hero">
      <div class="container hero__content">
        <h1 class="logo" aria-label="Stimulus dot AI">
          Stimulus<span class="logo__dot" aria-hidden="true">.</span>AI
        </h1>
        <p class="tagline">From Job Description to evidence-anchored signals — without the fluff.</p>

        <div class="hero__hud">
          <div id="health" class="badge" aria-live="polite">
            <span class="dot" aria-hidden="true"></span><span>checking…</span>
          </div>

          <label class="toggle">
            <input id="live" type="checkbox" />
            <span class="toggle__track" aria-hidden="true"></span>
            <span class="toggle__label">Live mode</span>
          </label>
        </div>
      </div>
    </header>

    <main class="container main">
      <section class="form-card" aria-labelledby="jdlabel">
        <label id="jdlabel" for="jd" class="sr-only">Paste Job Description</label>
        <textarea id="jd" rows="12" placeholder="Paste a JD here…"></textarea>

        <!-- Unified Controls Bar (Play/Stop + candidate + resume/audio) -->
        <div class="controls" role="group" aria-label="Actions">
          <!-- Compile -->
          <button id="compileBtn" class="btn-circle btn-compile" aria-label="Compile" title="Compile">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          <!-- Clear -->
          <button id="clearBtn" class="btn-circle btn-clear" aria-label="Clear" title="Clear">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M18.3 5.71L12 12.01 5.7 5.71 4.29 7.12 10.6 13.4 4.29 19.7 5.7 21.11 12 14.82 18.3 21.11 19.71 19.7 13.42 13.4 19.71 7.12z"/>
            </svg>
          </button>

          <!-- Divider -->
          <div aria-hidden="true" style="width:1px;height:32px;margin:0 6px;background:linear-gradient(to bottom,rgba(255,255,255,.06),rgba(255,255,255,.14),rgba(255,255,255,.06));border-radius:1px;"></div>

          <!-- Candidate chip -->
          <input id="cand" type="text" placeholder="candidate"
                 aria-label="Candidate ID"
                 style="height:38px;min-width:120px;max-width:180px;padding:0 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0d141d;color:#e8edf2;outline:none;"
                 onfocus="this.style.boxShadow='0 0 0 3px rgba(41,211,255,.22)';"
                 onblur="this.style.boxShadow='none';" />

          <!-- Hidden file inputs -->
          <input id="resumeFile" type="file" accept=".pdf,.docx,.txt,.md" style="position:absolute;left:-9999px;opacity:0;" />
          <input id="audioFile"  type="file" accept="audio/*"                style="position:absolute;left:-9999px;opacity:0;" />

          <!-- Resume button -->
          <button id="resumeBtn" class="btn-circle btn-ghost" aria-label="Attach resume" title="Attach resume">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M16 2H8a2 2 0 0 0-2 2v16l6-3 6 3V4a2 2 0 0 0-2-2z"></path>
            </svg>
          </button>

          <!-- Audio button -->
          <button id="audioBtn" class="btn-circle btn-ghost" aria-label="Attach audio" title="Attach audio">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2z"></path>
            </svg>
          </button>

          <!-- Status line -->
          <span id="artifactsMsg" style="margin-left:6px;font-size:.92rem;color:#a8b2bd;" aria-live="polite"></span>
        </div>
      </section>

      <section id="result" class="result" style="display:none;">
        <h2 id="role" class="result__role"></h2>
        <div id="company" class="result__company"></div>
        <div id="themes" class="grid"></div>
      </section>
    </main>
  </div>

  <script>
    // --- Intro timing: force-show PNG for 5s on black, then reveal app ---
    window.addEventListener('DOMContentLoaded', () => {
      const intro = document.getElementById('intro');
      const app   = document.getElementById('app');
      setTimeout(() => { intro.style.display = 'none'; app.classList.add('ready'); }, 5000);
    });

    // --- Health ping (neutral → green + pulse) ---
    async function pingHealth(){
      const badge = document.getElementById('health');
      try {
        const r = await fetch('/health');
        if (r.ok) {
          badge.className = 'badge ok';
          badge.querySelector('span:nth-child(2)').textContent = 'healthy';
        } else {
          badge.className = 'badge';
          badge.querySelector('span:nth-child(2)').textContent = 'checking…';
        }
      } catch {
        badge.className = 'badge';
        badge.querySelector('span:nth-child(2)').textContent = 'checking…';
      }
    }
    pingHealth(); setInterval(pingHealth, 8000);

    // Shortcuts
    const $ = (id) => document.getElementById(id);

    // --- Compile / Clear (unchanged) ---
    $('compileBtn').addEventListener('click', async () => {
      const text = $('jd').value.trim();
      if (!text) { alert('Paste a JD first.'); return; }
      const live = $('live').checked;
      const qs = live ? '?dry=0' : '';
      const r = await fetch('/jd/60s' + qs, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text })
      });
      if (!r.ok) { alert('Compile failed.'); return; }
      const data = await r.json();
      const s = data.schema || {};

      const companyRaw = (s.company ?? '').toString().trim();
      const hideCompany = !companyRaw || /^(n\/?a|none|null|not specified|unspecified)$/i.test(companyRaw);

      $('role').textContent = s.role_title || '—';
      $('company').textContent = hideCompany ? '' : companyRaw;
      $('company').style.display = hideCompany ? 'none' : 'block';

      const c = $('themes'); c.innerHTML = '';
      (s.themes || []).forEach(t => {
        const div = document.createElement('div');
        div.className = 'theme';
        div.innerHTML = `
          <h3>${t.name || 'Theme'}</h3>
          <strong>Requirements</strong>
          <ul>${(t.requirements||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
          <strong>Success Indicators</strong>
          <ul>${(t.success_indicators||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
        `;
        c.appendChild(div);
      });

      document.querySelector('#result').style.display = 'block';
      document.querySelector('#result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    $('clearBtn').addEventListener('click', () => {
      $('jd').value = '';
      $('live').checked = false;
      document.querySelector('#result').style.display = 'none';
      $('themes').innerHTML = '';
      $('role').textContent = '';
      $('company').textContent = '';
      $('artifactsMsg').textContent = '';
    });

    // --- Helpers for the status line (safe HTML preview) ---
    const esc = (s) => (s ?? '').toString().replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
    ));
    const setMsg = (t) => { $('artifactsMsg').textContent = t; };
    const setMsgHTML = (h) => { $('artifactsMsg').innerHTML = h; };
    const postForm = async (url, fd) => {
      const r = await fetch(url, { method:'POST', body: fd });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    };

    // --- Unified Controls: resume/audio with Live toggle threading ---
    $('resumeBtn').addEventListener('click', () => $('resumeFile').click());
    $('audioBtn').addEventListener('click',  () => $('audioFile').click());

    $('resumeFile').addEventListener('change', async () => {
      const f = $('resumeFile').files[0]; if (!f) return;
      const cand = ($('cand').value || '').trim() || 'anon';
      const live = $('live').checked;
      const qs = live ? '?dry=0' : '';  // Live toggle now controls artifacts too

      const fd = new FormData();
      fd.append('candidate_id', cand);
      fd.append('file', f);

      setMsg('Uploading resume…');
      try {
        const res = await postForm('/artifacts/resume' + qs, fd);
        setMsg(`Resume ✓  claims: ${res.claims_count ?? '?'}  → ${res.path ?? ''}`);
      } catch (e) {
        setMsg('Resume upload failed');
      } finally {
        $('resumeFile').value = '';
      }
    });

    $('audioFile').addEventListener('change', async () => {
      const f = $('audioFile').files[0]; if (!f) return;
      const cand = ($('cand').value || '').trim() || 'anon';
      const live = $('live').checked;
      const qs = live ? '?dry=0' : '';  // Live toggle threaded through

      const fd = new FormData();
      fd.append('candidate_id', cand);
      fd.append('file', f);

      setMsg('Transcribing…');
      try {
        const res = await postForm('/artifacts/audio' + qs, fd);
        const chars = res.transcript_chars ?? '?';
        const prev  = esc(res.preview ?? '').trim();
        if (prev) {
          setMsgHTML(
            `Audio ✓&nbsp; transcript: ${chars} chars
             <details style="display:inline-block;margin-left:8px;">
               <summary style="cursor:pointer;color:#e8edf2;display:inline;">Preview</summary>
               <pre style="white-space:pre-wrap;margin:.35rem 0 0;color:#a8b2bd;">${prev}</pre>
             </details>`
          );
        } else {
          setMsg(`Audio ✓  transcript: ${chars} chars`);
        }
      } catch (e) {
        setMsg('Audio upload failed');
      } finally {
        $('audioFile').value = '';
      }
    });
  </script>
</body>
</html>
