<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stimulus AI — Adapter Card</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="/static/styles.css">

  <style>
    .coverage{ margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .coverage__overall{ font-weight:700; padding:.28rem .6rem; border-radius:999px; background:rgba(52,211,153,.14); border:1px solid rgba(52,211,153,.35); box-shadow:0 0 0 2px rgba(52,211,153,.12); }
    .pill{ padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); font-size:.9rem; }
    details.receipt{ margin:.18rem 0 .35rem 1.1rem; }
    details.receipt > ul{ max-height:220px; overflow:auto; padding-right:6px; }
    .receipt__snippet{ word-break: break-word; }
    .muted{ color:#a8b2bd; }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .select{ height:38px; padding:0 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:#0d141d; color:#e8edf2; outline:none; }
    .select:focus{ box-shadow:0 0 0 3px rgba(41,211,255,.22); }
    .note{ font-size:.92rem; color:#a8b2bd; }
    .badge-mini{ display:inline-flex; align-items:center; gap:6px; padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); }
    .badge-mini video{ width:38px; height:22px; object-fit:cover; border-radius:6px; display:inline-block; }
    .muted-tip{ opacity:.8 }

    /* Processing overlay */
    .processing-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(6, 10, 15, 0.72);
      backdrop-filter: blur(2px);
      z-index: 9999;
    }
    .processing-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .processing-box img {
      width: 280px;
      height: auto;
      image-rendering: auto;
    }
    .processing-label {
      color: #e8edf2;
      font-weight: 600;
      letter-spacing: .3px;
      opacity: .9;
    }
  </style>
</head>
<body>

  <div id="processingOverlay" class="processing-overlay" aria-hidden="true">
    <div class="processing-box">
      <img src="/static/stimulate_4s_progression.gif" alt="Processing…" />
      <div id="processingLabel" class="processing-label">Processing…</div>
    </div>
  </div>

  <div id="intro" class="intro">
    <img src="/static/mcburney.png" alt="McBurney Group mark" id="introImg" class="intro__img">
  </div>

  <div id="app" class="app">
    <header class="hero">
      <div class="container hero__content">
        <h1 class="logo" aria-label="Stimulus dot AI">Stimulus<span class="logo__dot">.</span>AI</h1>
        <p class="tagline">From Job Description to evidence-anchored signals — without the fluff.</p>

        <div class="hero__hud">
          <div id="health" class="badge" aria-live="polite">
            <span class="dot"></span><span>checking…</span>
          </div>

          <label class="toggle">
            <input id="live" type="checkbox" />
            <span class="toggle__track"></span>
            <span class="toggle__label">Live mode</span>
          </label>
        </div>
      </div>
    </header>

    <main class="container main">
      <section class="form-card" aria-labelledby="jdlabel">
        <label id="jdlabel" for="jd" class="sr-only">Paste Job Description</label>
        <textarea id="jd" rows="12" placeholder="Paste a JD here…"></textarea>

        <div class="controls" role="group" aria-label="Actions">
          <!-- Compile -->
          <button id="compileBtn" class="btn-circle btn-compile" aria-label="Compile" title="Compile">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
          </button>

          <!-- Clear -->
          <button id="clearBtn" class="btn-circle btn-clear" aria-label="Clear" title="Clear">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M18.3 5.71L12 12.01 5.7 5.71 4.29 7.12 10.6 13.4 4.29 19.7 5.7 21.11 12 14.82 18.3 21.11 19.71 19.7 13.42 13.4 19.71 7.12z"/></svg>
          </button>

          <div aria-hidden="true" style="width:1px;height:32px;margin:0 6px;background:linear-gradient(to bottom,rgba(255,255,255,.06),rgba(255,255,255,.14),rgba(255,255,255,.06));border-radius:1px;"></div>

          <!-- Candidate row -->
          <div class="row" style="gap:6px;">
            <input id="cand" type="text" placeholder="candidate" aria-label="Candidate ID"
                   style="height:38px;min-width:120px;max-width:180px;padding:0 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0d141d;color:#e8edf2;outline:none;"
                   onfocus="this.style.boxShadow='0 0 0 3px rgba(41,211,255,.22)';" onblur="this.style.boxShadow='none';" />
            <select id="candSelect" class="select" title="Pick a candidate"><option value="">— pick candidate —</option></select>
            <button id="loadBtn" class="btn-circle btn-ghost" aria-label="Load artifacts" title="Load artifacts for selected candidate">
              <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.84v4h5.66V9h3.84L12 2z"></path></svg>
            </button>
          </div>

          <!-- Hidden file inputs -->
          <input id="resumeFile" type="file" accept=".pdf,.docx,.txt,.md" style="position:absolute;left:-9999px;opacity:0;" />
          <input id="audioFile"  type="file" accept="audio/*"                style="position:absolute;left:-9999px;opacity:0;" />
          <input id="videoFile"  type="file" accept=".mp4,.mov,.m4v,.webm,.mkv" style="position:absolute;left:-9999px;opacity:0;" />

          <!-- Upload buttons -->
          <button id="resumeBtn" class="btn-circle btn-ghost" aria-label="Attach resume" title="Attach resume">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M16 2H8a2 2 0 0 0-2 2v16l6-3 6 3V4a2 2 0 0 0-2-2z"></path></svg>
          </button>
          <button id="audioBtn" class="btn-circle btn-ghost" aria-label="Attach audio" title="Attach audio">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M3 12a9 9 0 0 1 18 0v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1a7 7 0 0 0-14 0h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5z"></path></svg>
          </button>
          <button id="videoBtn" class="btn-circle btn-ghost" aria-label="Attach video" title="Attach video">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M17 10.5V7a2 2 0 0 0-2-2H6A2 2 0 0 0 4 7v10a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-3.5l4 4v-11l-4 4z"></path></svg>
          </button>

          <!-- Build Evidence -->
          <button id="evidenceBtn" class="btn-circle btn-compile" aria-label="Build evidence map" title="Build evidence">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L19 21.49 21.49 19l-5.99-5zM4 9.5C4 6.46 6.46 4 9.5 4S15 6.46 15 9.5 12.54 15 9.5 15 4 12.54 4 9.5z"/></svg>
          </button>

          <span id="artifactsMsg" class="note" aria-live="polite"></span>
        </div>
      </section>

      <section id="result" class="result" style="display:none;">
        <h2 id="role" class="result__role"></h2>
        <div id="company" class="result__company"></div>

        <div id="coverage" class="coverage" style="display:none;">
          <span id="covOverall" class="coverage__overall"></span>
          <div id="covThemes" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>

        <div id="themes" class="grid"></div>
      </section>
    </main>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const intro = document.getElementById('intro');
      const app   = document.getElementById('app');
      setTimeout(() => { intro.style.display = 'none'; app.classList.add('ready'); }, 5000);
    });

    async function pingHealth(){
      const badge = document.getElementById('health');
      try {
        const r = await fetch('/health');
        badge.className = r.ok ? 'badge ok' : 'badge';
        badge.querySelector('span:nth-child(2)').textContent = r.ok ? 'healthy' : 'checking…';
      } catch {
        badge.className = 'badge';
        badge.querySelector('span:nth-child(2)').textContent = 'checking…';
      }
    }
    pingHealth(); setInterval(pingHealth, 8000);

    const $ = (id) => document.getElementById(id);
    const STATE = { schema: null, claims: [], resume_path: "", transcript_path: "", audio_path: "", audio_meta: null, video_path: "", video_meta: null };

    // --- Processing overlay / button gating ---
    const OVERLAY_MIN_MS = 8000; // two loops of 4s gif
    function disableControls(disabled){
      const ids = ["compileBtn","clearBtn","loadBtn","resumeBtn","audioBtn","videoBtn","evidenceBtn","cand","candSelect","live"];
      ids.forEach(id => { const el = $(id); if (el) el.disabled = !!disabled; });
    }
    function showProcessing(label){
      disableControls(true);
      const res = $('result'); if (res) res.style.opacity = '0.12';
      $('processingLabel').textContent = label || 'Processing…';
      $('processingOverlay').style.display = 'flex';
    }
    function hideProcessing(){
      $('processingOverlay').style.display = 'none';
      const res = $('result'); if (res) res.style.opacity = '';
      disableControls(false);
    }
    async function gateWithSpinner(promise, label){
      showProcessing(label);
      const minWait = new Promise(r => setTimeout(r, OVERLAY_MIN_MS));
      try{
        const [result] = await Promise.all([promise, minWait]);
        return result;
      } finally { hideProcessing(); }
    }

    function esc(s){
    return (s ?? '').toString().replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
    }
    const setMsg = (t) => { $('artifactsMsg').textContent = t; };
    const setMsgHTML = (h) => { $('artifactsMsg').innerHTML = h; };
    const postForm = async (url, fd) => {
      const r = await fetch(url, { method:'POST', body: fd });
      if (!r.ok) {
        let msg = '';
        try { msg = (await r.json()).detail?.message || (await r.text()); } catch { msg = await r.text(); }
        throw new Error(msg || 'Upload failed');
      }
      return r.json();
    };

    function humanSizeMB(n){ return (Math.round(n*100)/100).toFixed(2) + ' MB'; }
    function mmss(sec){ sec = Math.max(0, Math.round(sec||0)); const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

    function renderVideoBadge(vpath, meta){
      if (!vpath || !meta) return '';
      return `<span class="badge-mini" title="video ✓ ${mmss(meta.duration_sec)} · ${meta.codec} · ${humanSizeMB(meta.filesize_mb)}">
        <video src="${vpath}"></video>
        <span>video ✓ ${mmss(meta.duration_sec)} · ${meta.codec} · ${humanSizeMB(meta.filesize_mb)}</span>
      </span>`;
    }
    function renderAudioBadge(meta){
      if (!meta) return '';
      return `<span class="badge-mini" title="audio ✓ ${mmss(meta.duration_sec)} · ${meta.codec} · ${humanSizeMB(meta.filesize_mb)}">
        <span style="display:inline-flex;align-items:center;gap:6px;">
          <!-- Headphones icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 3a9 9 0 0 0-9 9v5a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H5a7 7 0 0 1 14 0h-1a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-5a9 9 0 0 0-9-9z"></path>
          </svg>
          <span>audio ✓ ${mmss(meta.duration_sec)} · ${meta.codec} · ${humanSizeMB(meta.filesize_mb)}</span>
        </span>
      </span>`;
    }
    function renderResumeBadge(path){
      if (!path) return '';
      return `<span class="badge-mini" title="resume attached">resume ✓</span>`;
    }

    function enforceButtons(latest){
      const hasAudio = (!!latest.audio_meta || (!!latest.transcript_chars && !latest.video_path));
      const hasVideo = !!latest.video_path;

      $('audioBtn').title = hasVideo
        ? "Attach audio (will offer to replace existing video)"
        : "Attach audio";

      $('videoBtn').title = hasAudio
        ? "Attach video (will offer to replace existing audio)"
        : "Attach video";
    }

    async function refreshCandidates(){
      try {
        const r = await fetch('/artifacts/candidates');
        if (!r.ok) return;
        const data = await r.json();
        const sel = $('candSelect');
        const curr = sel.value;
        sel.innerHTML = '<option value="">— pick candidate —</option>';
        (data.candidates || []).forEach(id => { const opt = document.createElement('option'); opt.value = id; opt.textContent = id; sel.appendChild(opt); });
        if (curr && (data.candidates || []).includes(curr)) sel.value = curr;
      } catch {}
    }
    refreshCandidates(); setInterval(refreshCandidates, 15000);

    $('cand').addEventListener('input', () => {
      const v = ($('cand').value || '').trim();
      const sel = $('candSelect');
      const match = [...sel.options].find(o => o.value === v);
      sel.value = match ? v : '';
    });
    $('candSelect').addEventListener('change', () => {
      const v = $('candSelect').value;
      if (v) $('cand').value = v;
    });

    $('loadBtn').addEventListener('click', async () => {
      const cand = ($('candSelect').value || $('cand').value || '').trim();
      if (!cand) { alert('Pick or type a candidate first.'); return; }
      setMsg('Loading saved artifacts…');
      try {
        const r = await fetch(`/artifacts/for/${encodeURIComponent(cand)}`);
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();

        const latest = data.latest || {};
        STATE.claims = Array.isArray(latest.claims) ? latest.claims : [];
        STATE.resume_path = latest.resume_path || "";
        STATE.transcript_path = latest.transcript_path || "";
        STATE.audio_path = latest.audio_path || "";
        STATE.audio_meta = latest.audio_meta || null;
        STATE.video_path = latest.video_path || "";
        STATE.video_meta = latest.video_meta || null;

        const bits = [];
        bits.push(`Loaded candidate: ${cand}`);
        const rbadge = renderResumeBadge(STATE.resume_path);
        if (rbadge) bits.push(rbadge);
        if (latest.claims_count) bits.push(`claims: ${latest.claims_count}`);
        if (latest.transcript_chars) bits.push(`transcript: ${latest.transcript_chars} chars`);

        const vbadge = renderVideoBadge(latest.video_path, latest.video_meta);
        const abadge = renderAudioBadge(latest.audio_meta);
        const prev = esc(latest.transcript_preview || '');
        const previewHTML = prev
          ? ` <details style="display:inline-block;margin-left:8px;">
               <summary style="cursor:pointer;color:#e8edf2;display:inline;">Transcript preview</summary>
               <pre style="white-space:pre-wrap;margin:.35rem 0 0;color:#a8b2bd;">${prev}</pre>
             </details>` : '';

        setMsgHTML(bits.join(' · ') + (abadge ? ' · ' + abadge : '') + (vbadge ? ' · ' + vbadge : '') + previewHTML);
        enforceButtons(latest);
      } catch (e) { setMsg('Load failed'); }
    });

    // Compile JD
    $('compileBtn').addEventListener('click', async () => {
      const text = $('jd').value.trim();
      if (!text) { alert('Paste a JD first.'); return; }
      const live = $('live').checked;
      const qs = live ? '?dry=0' : '';
      const r = await gateWithSpinner(fetch('/jd/60s' + qs, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text }) }), 'Compile');
      if (!r.ok) { alert('Compile failed.'); return; }
      const data = await r.json();
      const s = data.schema || {};
      STATE.schema = s;

      const companyRaw = (s.company ?? '').toString().trim();
      const hideCompany = !companyRaw || /^(n\/?a|none|null|not specified|unspecified)$/i.test(companyRaw);

      $('role').textContent = s.role_title || '—';
      $('company').textContent = hideCompany ? '' : companyRaw;
      $('company').style.display = hideCompany ? 'none' : 'block';

      const grid = $('themes'); grid.innerHTML = '';
      (s.themes || []).forEach(t => {
        const div = document.createElement('div');
        div.className = 'theme';
        const reqList = (t.requirements || []).map(x => `<li>${esc(x)}</li>`).join('');
        const siList  = (t.success_indicators || []).map(x => `<li>${esc(x)}</li>`).join('');
        div.innerHTML = `
          <h3>${t.name || 'Theme'}</h3>
          <strong>Requirements</strong>
          <ul class="reqs">${reqList}</ul>
          <strong>Success Indicators</strong>
          <ul class="reqs">${siList}</ul>
        `;
        grid.appendChild(div);
      });

      $('coverage').style.display = 'none';
      $('covOverall').textContent = '';
      $('covThemes').innerHTML = '';

      document.querySelector('#result').style.display = 'block';
      document.querySelector('#result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Clear
    $('clearBtn').addEventListener('click', () => {
      $('jd').value = '';
      $('live').checked = false;
      document.querySelector('#result').style.display = 'none';
      $('themes').innerHTML = '';
      $('role').textContent = '';
      $('company').textContent = '';
      $('artifactsMsg').textContent = '';
      $('coverage').style.display = 'none';
      STATE.schema = null; STATE.claims = []; STATE.resume_path = ""; STATE.transcript_path = ""; STATE.audio_path = ""; STATE.audio_meta = null; STATE.video_path = ""; STATE.video_meta = null;
    });

    $('resumeBtn').addEventListener('click', () => $('resumeFile').click());
    $('audioBtn').addEventListener('click',  () => $('audioFile').click());
    $('videoBtn').addEventListener('click',  () => $('videoFile').click());

    $('resumeFile').addEventListener('change', async () => {
      const f = $('resumeFile').files[0]; if (!f) return;
      const cand = ($('candSelect').value || $('cand').value || '').trim() || 'anon';
      const live = $('live').checked;
      let qs = live ? '?dry=0' : '';

      setMsg('Uploading resume…');
      try {
        const fd = new FormData(); fd.append('candidate_id', cand); fd.append('file', f);
        const res = await postForm('/artifacts/resume' + qs, fd);
        STATE.claims = Array.isArray(res.claims) ? res.claims : [];
        STATE.resume_path = res.path || "";
        const rbadge = renderResumeBadge(STATE.resume_path);
        setMsgHTML(`${rbadge} · Resume ✓  claims: ${res.claims_count ?? '?'}  → ${res.path ?? ''}`);
        await refreshCandidates(); $('cand').value = cand; $('candSelect').value = cand;
      } catch (e){ setMsg('Resume upload failed: ' + (e?.message||'')); }
      finally { $('resumeFile').value = ''; }
    });

    async function fetchLatestFor(cand){
      const r = await fetch(`/artifacts/for/${encodeURIComponent(cand)}`);
      if (!r.ok) return null;
      return r.json();
    }

    $('audioFile').addEventListener('change', async () => {
      const f = $('audioFile').files[0]; if (!f) return;
      const cand = ($('candSelect').value || $('cand').value || '').trim() || 'anon';
      const live = $('live').checked;

      const hasVideo = !!STATE.video_path;
      let qs = live ? '?dry=0' : '';
      if (hasVideo){
        const ok = window.confirm('Replace existing video with this audio? This will remove the current video + transcript.');
        if (!ok){ $('audioFile').value=''; return; }
        qs += (qs ? '&' : '?') + 'replace=1';
      }

      const fd = new FormData(); fd.append('candidate_id', cand); fd.append('file', f);

      setMsg('Transcribing…');
      try {
        const res = await gateWithSpinner(postForm('/artifacts/audio' + qs, fd), 'Transcribe');
        // Refresh resume presence so the pill appears immediately
        try {
          const latest = await fetchLatestFor(cand);
          if (latest?.latest) {
            STATE.resume_path = latest.latest.resume_path || STATE.resume_path;
          }
        } catch {}
        STATE.video_path = ""; STATE.video_meta = null; // replaced
        STATE.audio_meta = res.audio_meta || null;
        STATE.audio_path = res.audio_path || "";
        STATE.transcript_path = res.transcript_path || "";
        const chars = res.transcript_chars ?? '?';
        const prev  = esc(res.preview ?? '').trim();
        const abadge = renderAudioBadge(res.audio_meta);
        const rbadge = renderResumeBadge(STATE.resume_path);
        setMsgHTML(`${rbadge ? rbadge + ' · ' : ''}${abadge ? abadge + ' · ' : ''}` + (prev
          ? `Audio ✓ transcript: ${chars} chars <details style="display:inline-block;margin-left:8px;"><summary style="cursor:pointer;color:#e8edf2;display:inline;">Preview</summary><pre style="white-space:pre-wrap;margin:.35rem 0 0;color:#a8b2bd;">${prev}</pre></details>`
          : `Audio ✓ transcript: ${chars} chars`));
        await refreshCandidates(); $('cand').value = cand; $('candSelect').value = cand;
        enforceButtons({ transcript_chars: chars, video_path: STATE.video_path, audio_meta: STATE.audio_meta });
      } catch (e){ setMsg('Audio upload failed: ' + (e?.message||'')); }
      finally { $('audioFile').value = ''; }
    });

    function checkVideoDuration(file){
      return new Promise((resolve) => {
        const url = URL.createObjectURL(file);
        const v = document.createElement('video');
        v.preload = 'metadata';
        v.onloadedmetadata = () => { URL.revokeObjectURL(url); resolve(v.duration || 0); };
        v.onerror = () => { URL.revokeObjectURL(url); resolve(0); };
        v.src = url;
      });
    }

    // Client-side video limits
    $('videoFile').addEventListener('change', async () => {
      const f = $('videoFile').files[0]; if (!f) return;
      const cand = ($('candSelect').value || $('cand').value || '').trim() || 'anon';
      const live = $('live').checked;

      const MB = f.size/(1024*1024);
      if (MB > 150){ setMsg('Video too large (max 150 MB).'); $('videoFile').value=''; return; }
      const dur = await checkVideoDuration(f);
      if (dur && dur > 120 && live){ setMsg('Video too long (max 2 minutes).'); $('videoFile').value=''; return; }

      const hasAudio = (!!STATE.transcript_path && !STATE.video_path) || !!STATE.audio_meta;

      let qs = live ? '?dry=0' : '';
      if (hasAudio){
        const ok = window.confirm('Replace existing audio with this video? This will remove the current audio + transcript.');
        if (!ok){ $('videoFile').value=''; return; }
        qs += (qs ? '&' : '?') + 'replace=1';
      }

      const fd = new FormData(); fd.append('candidate_id', cand); fd.append('file', f);

      setMsg('Processing video… (extracting audio → transcribing)');
      try {
        const res = await gateWithSpinner(postForm('/artifacts/video' + qs, fd), 'FFmpeg · Whisper');
        // Refresh resume presence so the pill appears immediately
        try {
          const latest = await fetchLatestFor(cand);
          if (latest?.latest) {
            STATE.resume_path = latest.latest.resume_path || STATE.resume_path;
          }
        } catch {}
        STATE.transcript_path = res.transcript_path || "";
        STATE.audio_meta = null; STATE.audio_path = "";
        STATE.video_path = res.video_path || "";
        STATE.video_meta = { duration_sec: res.duration_sec, codec: res.codec, bitrate_kbps: res.bitrate_kbps, filesize_mb: res.filesize_mb, created_at: res.created_at };

        const prev = esc(res.preview || '').trim();
        const vbadge = renderVideoBadge(STATE.video_path, STATE.video_meta);
        const rbadge = renderResumeBadge(STATE.resume_path);
        setMsgHTML(`${rbadge ? rbadge + ' · ' : ''}${vbadge}${prev ? ' · ' : ''}${prev ? `<span class="muted-tip">${prev}</span>` : ''}`);

        await refreshCandidates(); $('cand').value = cand; $('candSelect').value = cand;
        enforceButtons({ transcript_chars: res.transcript_chars, video_path: STATE.video_path, audio_meta: STATE.audio_meta });
      } catch (e){ setMsg('Video upload failed: ' + (e?.message||'')); }
      finally { $('videoFile').value = ''; }
    });

    function highlightTerms(snippetEscaped, terms){
      const text = snippetEscaped || '';
      const uniq = Array.from(new Set((terms || []).map(t => (t||'').toString()).filter(Boolean)));
      uniq.sort((a,b) => (b.length||0)-(a.length||0));
      const lower = text.toLowerCase();
      const ranges = [];
      for (const term of uniq){
        const t = term.toLowerCase(); if (!t) continue;
        let idx = 0;
        while (idx < lower.length){
          const at = lower.indexOf(t, idx);
          if (at === -1) break;
          ranges.push([at, at + t.length]);
          idx = at + Math.max(1, t.length);
        }
      }
      ranges.sort((a,b)=>a[0]-b[0]);
      const merged = [];
      for (const r of ranges){
        if (!merged.length || r[0] > merged[merged.length-1][1]) merged.push(r.slice());
        else merged[merged.length-1][1] = Math.max(merged[merged.length-1][1], r[1]);
      }
      let out = ''; let prev = 0;
      for (const [s,e] of merged){
        out += text.slice(prev, s);
        out += '<span class="hit">' + text.slice(s,e) + '</span>';
        prev = e;
      }
      out += text.slice(prev);
      return out;
    }

    $('evidenceBtn').addEventListener('click', async () => {
      if (!STATE.schema) { alert('Compile the JD first.'); return; }
      const cand = ($('candSelect').value || $('cand').value || '').trim() || 'anon';
      const payload = { candidate_id: cand, schema: STATE.schema, claims: STATE.claims || [], transcript_path: STATE.transcript_path || null };

      setMsg('Building evidence map…');
      const live = $('live').checked;
      const qs = live ? '?dry=0' : '';
      try {
        const r = await gateWithSpinner(fetch('/evidence/build' + qs, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }), 'Build');
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        renderEvidence(data);
      } catch (e) {
        const ok = window.confirm('Live build failed or API unavailable. Use lexicon fallback instead?');
        if (!ok) { setMsg('Evidence build cancelled'); return; }
        try{
          const r2 = await gateWithSpinner(fetch('/evidence/build?dry=1', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }), 'Build (fallback)');
          if (!r2.ok) throw new Error(await r2.text());
          const data2 = await r2.json();
          renderEvidence(data2);
        } catch { setMsg('Fallback build failed'); }
      }
    });

    function renderEvidence(data){
      $('coverage').style.display = 'flex';
      $('covOverall').textContent = `Overall: ${data.coverage?.overall ?? '?'}%`;
      const ct = $('covThemes'); ct.innerHTML = '';
      const by = data.coverage?.by_theme || {};
      Object.keys(by).forEach(name => { const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = `${name}: ${by[name]}%`; ct.appendChild(pill); });

      const grid = $('themes'); grid.innerHTML = '';
      const adapter = data.adapter || {};
      const themes = STATE.schema?.themes || [];

      themes.forEach(t => {
        const tname = t.name || 'Theme';
        const rows = adapter[tname] || [];
        const div = document.createElement('div');
        div.className = 'theme';

        const reqList = rows.map(row => {
          const evid = (row.evidence || []).map(ev => {
            const src = (ev.source_ref?.kind || 'artifact');
            const line = ev.source_ref?.line != null ? ` #${ev.source_ref.line}` : '';
            const snippetHTML = highlightTerms(esc(ev.snippet), ev.hit_terms || []);
            return `<li class="muted">[${src}${line}] <span class="receipt__snippet">${snippetHTML}</span></li>`;
          }).join('');
          const receipt = evid ? `<details class="receipt"><summary>Receipts</summary><ul>${evid}</ul></details>` : '';

          const oqs = (row.open_questions || []);
          const oqHTML = oqs.length ? `<div class="open-qs"><em>Open questions</em><ul>${oqs.map(q => `<li class="muted">${esc(q)}</li>`).join('')}</ul></div>` : '';

          return `<li><span>${esc(row.requirement || '')}</span>${receipt}${oqHTML}</li>`;
        }).join('');

        const siList = (t.success_indicators || []).map(x => `<li>${esc(x)}</li>`).join('');

        div.innerHTML = `
          <h3>${tname}</h3>
          <strong>Requirements (matched items show receipts)</strong>
          <ul class="reqs">${reqList}</ul>
          <strong>Success Indicators</strong>
          <ul class="reqs">${siList}</ul>
        `;
        grid.appendChild(div);
      });

      setMsg('Evidence ✓  coverage updated');
      document.querySelector('#result').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  </script>
</body>
</html>
